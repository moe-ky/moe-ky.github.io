const content = [
  {
    title: "Welcome",
    html: `
      <div class="cover-page">
        <h2>ORDER OF SERVICE FOR THE MARRIAGE OF</h2>
        <h1 class="names">Shanice Wilson</h1>
        <h1 class="ampersand">&amp;</h1>
        <h1 class="names">Moyin Koiki</h1>
        <p class="details">All Saints, Fulham. Putney Bridge Approach, London SW6 3LA</p>
        <p class="details">Thursday 22nd May</p>
        <p class="details">Time to Arrive: 10:30</p>
      </div>`,
    centerHorizontal: true,
    centerVertical: true
  },
  {
    title: "Wedding Party",
    html: `
    <div class="scrolling-inner">
      <ul class="party-list">
        <li><strong>Officiant:</strong> Reverend Briony Mackie</li>
        <li><strong>Parents of the Bride:</strong> Mr & Mrs Wilson</li>
        <li><strong>Parents of the Groom:</strong> Mr & Mrs Koiki</li>
        <li><strong>Maid of Honour:</strong> Monique Wilson</li>
        <li><strong>Bridesmaid:</strong> Kiite Koiki</li>
        <li><strong>Bridesmaid:</strong> Tatiana Young</li>
        <li><strong>Best Man:</strong> Toby Shodipo</li>
        <li><strong>Groomsmen:</strong> Thilaxan Paramanathan</li>
        <li><strong>Groomsmen:</strong> Mide Shodipo</li>
        <li><strong>Groomsmen:</strong> Babatunde Animashaun</li>
        <li><strong>Groomsmen:</strong> Sean Animashaun</li>
        <li><strong>Groomsmen:</strong> Robert Animashaun</li>
        <li><strong>Ring Bearer:</strong> Adam Gbadamosi</li>
      </ul>
      </div>
    `
  },
  {
    title: "Order of the Day",
    text: "Follow the beautiful journey from the entrance to the blessing."
  },
  {
    title: "Entrance of the Bride",
    text: "Music: Ave Maria"
  },
  {
    title: "Welcome & Introduction",
    text: "By Reverend Briony Mackie"
  },
  {
    title: "HYMN: Lead Us, Heavenly Father, Lead Us",
    class: "hymn",
    html: `
      <div class="scrolling-inner">
        <p>Lead us, heavenly Father, lead us<br>
        through this world's tempestuous sea;<br>
        guard us, guide us, keep us, feed us<br>
        for your help is full and free,<br>
        here possessing every blessing<br>
        if our God our Father be.</p><br>
        <p>Saviour, by your grace restore us -<br>
        all our weaknesses are plain;<br>
        you have lived on earth before us,<br>
        you have felt our grief and pain:<br>
        tempted, taunted, yet undaunted,<br>
        from the depths you rose again.</p><br>
        <p>Spirit of our God, descending,<br>
        fill our hearts with holy peace;<br>
        love with every passion blending,<br>
        pleasure that can never cease:<br>
        thus provided, pardoned, guided,<br>
        ever shall our joys increase.</p>
      </div>`
  },
  {
    title: "The Declarations",
    text: "By Reverend"
  },
  {
    title: "Reading: 1 Corinthians 13:1–13",
    class: "reading",
    html: `
    <div class="scrolling-inner">
      <p>1 If I speak in the tongues of men and of angels, but have not love, I am a noisy gong or a clanging cymbal.</p>
      <p>2 And if I have prophetic powers, and understand all mysteries and all knowledge, and if I have all faith, so as to remove mountains, but have not love, I am nothing.</p>
      <p>3 If I give away all I have, and if I deliver up my body to be burned, but have not love, I gain nothing.</p>
      <p>4 Love is patient and kind; love does not envy or boast; it is not arrogant</p>
      <p>5 or rude. It does not insist on its own way; it is not irritable or resentful.</p>
      <p>6 It does not rejoice at wrongdoing but rejoices with the truth.</p>
      <p>7 Love bears all things, believes all things, hopes all things, endures all things.</p>
      <p>8 Love never ends. As for prophecies, they will pass away; as for tongues, they will cease; as for knowledge, it will pass away.</p>
      <p>9 For we know in part, and we prophesy in part,</p>
      <p>10 but when the perfect comes, the partial will pass away.</p>
      <p>11 When I was a child, I spoke like a child, I thought like a child, I reasoned like a child. When I became a man, I gave up childish ways.</p>
      <p>12 For now we see in a mirror dimly but then face to face. Now I know in part; then I shall know fully, even as I have been fully known.</p>
      <p>13 So now faith, hope, and love abide, these three; but the greatest of these is love.</p>
      </div>
    `
  },
  {
    title: "Reading: John 4:7–12",
    class: "reading",
    html: `
      <div class="scrolling-inner">
        <p>7 Dear friends, let us love one another, for love comes from God. Everyone who loves has been born of God and knows God.</p>
        <p>8 Whoever does not love does not know God, because God is love.</p>
        <p>9 This is how God showed his love among us: He sent his one and only Son into the world that we might live through him.</p>
        <p>10 This is love: not that we loved God, but that he loved us and sent his Son as an atoning sacrifice for our sins.</p>
        <p>11 Dear friends, since God so loved us, we also ought to love one another.</p>
        <p>12 No one has ever seen God; but if we love one another, God lives in us and his love is made complete in us.</p>
      </div>
    `
  },
  {
    title: "HYMN: Grace ‘Tis a Perfect Sound",
    class: "hymn",
    html: `
      <div class="scrolling-inner">
        <p>1 Grace! 'tis a charming sound<br>
        Harmonious to my ear;<br>
        Heaven with the echo shall resound,<br>
        And all the earth shall hear.</p>
  
        <p>2 Grace first contrived the way<br>
        To save rebellious man;<br>
        And all the steps that grace display<br>
        Which drew the wondrous plan.</p>
  
        <p>3 Grace taught my wandering feet<br>
        To tread the heavenly road;<br>
        And new supplies each hour I meet,<br>
        While pressing on to God.</p>
  
        <p>4 Grace all the works shall crown,<br>
        Through everlasting days;<br>
        It lays in heaven the topmost stone,<br>
        And well deserves the praise.</p>
      </div>
    `
  },
  {
    title: "Reading: Captain Corelli’s Mandolin",
    class: "reading",
    html: `
      <div class="scrolling-inner">
        <p>Love is a temporary madness; it erupts like volcanoes and then subsides. And when it subsides you have to make a decision. You have to work out whether your roots have so entwined together that it is inconceivable that you should ever part.</p>
  
        <p>Because this is what love is.</p>
  
        <p>Love is not breathlessness, it is not excitement, it is not the promulgation of promises of eternal passion. That is just being in love, which any fool can do.</p>
  
        <p>Love itself is what is left over when being in love has burned away, and this is both an art and a fortunate accident.</p>
  
        <p>Those that truly love have roots that grow towards each other underground, and when all the pretty blossoms have fallen from their branches, they find that they are one tree and not two.</p>
      </div>
    `
  },
  {
    title: "Sermon",
    text: "By Reverend"
  },
  {
    title: "The Vows & Rings",
    text: "Exchange of vows and rings between the Bride & Groom"
  },
  {
    title: "Signing of Registers",
    text: "Music: Stand by Me – Ben E King"
  },
  {
    title: "Prayers",
    text: "Led by Reverend"
  },
  {
    title: "The Lord’s Prayer",
    class: "prayer",
    html: `
      <div class="scrolling-inner">
        <p>Our Father, who art in heaven,<br>
        hallowed be thy name.</p>
  
        <p>Thy kingdom come, thy will be done;<br>
        on earth as it is in heaven.</p>
  
        <p>Give us this day our daily bread;<br>
        and forgive us our trespasses</p>
  
        <p>As we forgive those who trespass against us;<br>
        and lead us not into temptation,</p>
  
        <p>But deliver us from evil.<br>
        For thine is the Kingdom</p>
  
        <p>The power and the glory<br>
        For ever and ever.<br>
        Amen</p>
      </div>
    `
  },
  {
    title: "The Blessing",
    text: "By Reverend"
  },
  {
    title: "The Recessional",
    text: "Music: Best of My Love – The Emotions"
  },
  {
    title: "Confetti Time",
    text: "Guests are kindly invited to form two lines outside the church for a celebratory confetti send-off.",
    confetti: true,
  },
  {
    title: "Upload & View Photos",
    class: "upload-gallery",
    html: `
    <div class="upload-container">
      <input type="file" id="fileInput" multiple accept=".jpg,.jpeg,.png,.zip" />

      <button onclick="startUpload()" class="upload-btn">Upload Files</button>

      <p class="upload-instructions">
        Please upload any photos or videos you’ve taken today.<br>
        You can upload images or a .zip file (max 100MB).
      </p>

      <p id="uploadStatus" class="upload-status"></p>
    </div>

    <div id="gallery" class="scrolling-inner gallery-grid">
      <p>Loading photos...</p>
    </div>
  `,
    centerHorizontal: true,
    centerVertical: false
  },
];

const sectionsContainer = document.getElementById("sections");
const menuList = document.getElementById("menuList");
const sidebar = document.getElementById("sidebar");
const toggleButton = document.getElementById("menuToggle");
const closeButton = document.getElementById("closeSidebar");

let currentSection = 0;

// Build sections from content array
content.forEach((item, index) => {
  const section = document.createElement("div");
  section.className = `section colorful ${item.class || ""}`;
  if (item.centerHorizontal) section.classList.add("center-horizontal");
  if (item.centerVertical) section.classList.add("center-vertical");
  section.id = `section-${index}`;

  section.innerHTML = `
    <div class="content-container">
      <div class="section-content">
        <h1>${item.title}</h1>
        ${item.text ? `<p>${item.text}</p>` : item.html || ""}
      </div>
    </div>
    <div class="nav-floating-buttons">
      <button onclick="prevSection()" aria-label="Previous Section" class="nav-btn">&lt;</button>
      <button onclick="nextSection()" aria-label="Next Section" class="nav-btn">&gt;</button>
    </div>
  `;

  sectionsContainer.appendChild(section);

  const menuItem = document.createElement("li");
  menuItem.innerHTML = `<a href="#" onclick="goToSection(${index})">${item.title}</a>`;
  menuList.appendChild(menuItem);
});

function showSection(index) {
  document.querySelectorAll(".section").forEach((sec, i) => {
    sec.style.display = i === index ? "flex" : "none";
  });

  if (content[index].confetti) {
    launchConfetti();
  }

  if (
    content[index].class === "gallery" ||
    content[index].class === "upload-gallery"
  ) {
    loadGalleryImages();
  }
}

function nextSection() {
  if (currentSection < content.length - 1) {
    currentSection++;
    localStorage.setItem('currentSectionIndex', currentSection);
    showSection(currentSection);
  }
}

function prevSection() {
  if (currentSection > 0) {
    currentSection--;
    localStorage.setItem('currentSectionIndex', currentSection);
    showSection(currentSection);
  }
}

function goToSection(index) {
  currentSection = index;
  localStorage.setItem('currentSectionIndex', currentSection);
  showSection(currentSection);
  sidebar.classList.remove("open");
  toggleButton.classList.remove("hidden");
}

toggleButton.addEventListener("click", () => {
  sidebar.classList.add("open");
  toggleButton.classList.add("hidden");
});

closeButton.addEventListener("click", () => {
  sidebar.classList.remove("open");
  toggleButton.classList.remove("hidden");
});

document.addEventListener("keydown", e => {
  if (e.key === "ArrowRight") nextSection();
  if (e.key === "ArrowLeft") prevSection();
});

// Swipe support
let touchStartX = 0;
let touchEndX = 0;

document.addEventListener("touchstart", function (e) {
  touchStartX = e.changedTouches[0].screenX;
});

document.addEventListener("touchend", function (e) {
  touchEndX = e.changedTouches[0].screenX;
  handleGesture();
});

function handleGesture() {
  const swipeDistance = 50;
  if (touchEndX < touchStartX - swipeDistance) {
    nextSection();
  }
  if (touchEndX > touchStartX + swipeDistance) {
    prevSection();
  }
}

// Toast notice
window.addEventListener("load", () => {
  const hasSeenToast = localStorage.getItem("seenSwipeToast");
  const toast = document.getElementById("swipe-toast");
  const closeBtn = document.getElementById("dismiss-toast");

  if (window.innerWidth <= 768) {
    toast.classList.add("show");

    closeBtn.addEventListener("click", () => {
      toast.classList.remove("show");
      localStorage.setItem("seenSwipeToast", "true");
    });
  }
});

function launchConfetti() {
  confetti({
    particleCount: 150,
    spread: 70,
    origin: { y: 0.6 }
  });
}

async function startUpload() {
  const input = document.getElementById("fileInput");
  const status = document.getElementById("uploadStatus");
  status.textContent = "";

  const files = input.files;
  if (!files.length) {
    status.textContent = "Please select at least one file.";
    return;
  }

  const MAX_SIZE_MB = 100;
  let totalSize = 0;
  for (const file of files) {
    totalSize += file.size;
  }
  if (totalSize > MAX_SIZE_MB * 1024 * 1024) {
    status.textContent = "Total upload size exceeds 100MB.";
    return;
  }

  status.textContent = "Uploading files...";

  for (const file of files) {
    try {
      const res = await fetch('https://api-main.thecontentbench.com/upload-url', {
        method: 'POST',
        credentials: "include",
        body: JSON.stringify({
          userId: 'wedding-user',
          fileName: file.name,
          contentType: file.type,
          fileExtension: file.name.split(".").slice(-1)[0],
          fileSizeMb: file.size,
          serviceName: 'UPLOAD',
          contentType: file.type,
        })
      });

      const { response } = await res.json();

      const configUrlForUpload = (resp) => {
        const formData = new FormData();
        Object.keys(resp.fields).forEach(key => formData.append(key, resp.fields[key]));
        formData.append('file', file);
        return { url: resp.url, data: formData };
      };

      const upload = async (url, formData) => {
        const uploadResponse = await fetch(url, { method: 'POST', body: formData });
        if (!uploadResponse.ok) {
          throw new Error('Failed to upload. Please try again later.');
        }
      };

      const config = configUrlForUpload(response);
      await upload(config.url, config.data);

    } catch (err) {
      console.error("Upload failed:", err);
      status.textContent = "🚫🚫🚫Upload FAILED for one or more files.🚫🚫🚫";
      return;
    }
  }

  status.textContent = "✅ Upload successful! Thank you 🎉";
  setTimeout(() => location.reload(), 3000);
}

// Restore last section from localStorage
const savedIndex = parseInt(localStorage.getItem('currentSectionIndex'), 10);
if (!isNaN(savedIndex) && savedIndex >= 0 && savedIndex < content.length) {
  currentSection = savedIndex;
}

async function loadGalleryImages() {
  const gallery = document.getElementById("gallery");
  if (!gallery) return;

  try {
    const res = await fetch('https://api-main.thecontentbench.com/files', {
      method: 'POST',
      credentials: "include",
      body: JSON.stringify({
        userId: 'wedding-user',
        serviceName: 'UPLOAD',
      })
    });
    const { response } = await res.json();

    if (!response.length) {
      gallery.innerHTML = "<p>No photos uploaded yet. Check back later!</p>";
      return;
    }

    gallery.innerHTML = ""; // Clear loading text

    response.forEach(file => {
      const img = document.createElement("img");
      img.src = file;
      img.alt = "Uploaded Photo";
      gallery.appendChild(img);
    });
  } catch (err) {
    console.error("Error loading gallery:", err);
    gallery.innerHTML = "<p>Failed to load images. Please try again later.</p>";
  }
}

showSection(currentSection);
